<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Human Design Chart Calculator</title>
    <style>
        :root {
            --bg: #0f0f0f;
            --surface: #1a1a2e;
            --surface2: #16213e;
            --accent: #e94560;
            --accent2: #533483;
            --text: #eee;
            --text-dim: #999;
            --border: #333;
            --success: #4ecca3;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.25rem;
        }

        header p {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input, select {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.7rem 1rem;
            color: var(--text);
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }

        button {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.8rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
            width: 100%;
            margin-top: 0.5rem;
        }

        button:hover { opacity: 0.9; }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .result { display: none; }
        .result.visible { display: block; }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .result-header h2 {
            font-size: 1.5rem;
        }

        .type-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .type-Generator { background: #e6a817; color: #000; }
        .type-ManifestingGenerator { background: #e6a817; color: #000; }
        .type-Projector { background: #4ea8de; color: #000; }
        .type-Manifestor { background: #e94560; color: #fff; }
        .type-Reflector { background: #7b68ee; color: #fff; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-box {
            background: var(--bg);
            border-radius: 8px;
            padding: 1rem;
        }

        .stat-box .label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-box .value {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 0.2rem;
        }

        .section-title {
            font-size: 0.85rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            margin-top: 1rem;
        }

        .channels-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .channel-tag {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.3rem 0.6rem;
            font-size: 0.85rem;
            font-family: monospace;
        }

        .centers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.4rem;
        }

        .center-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.5rem;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .center-item.defined { color: var(--success); }
        .center-item.undefined { color: var(--text-dim); }

        .activations-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .activations-table th {
            text-align: left;
            color: var(--text-dim);
            font-weight: 500;
            padding: 0.4rem 0.6rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .activations-table td {
            padding: 0.4rem 0.6rem;
            border-bottom: 1px solid #1a1a1a;
        }

        .activation-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 600px) {
            .activation-columns { grid-template-columns: 1fr; }
        }

        .error-msg {
            background: #2d1117;
            border: 1px solid #e94560;
            border-radius: 8px;
            padding: 1rem;
            color: #e94560;
            display: none;
        }

        .error-msg.visible { display: block; }

        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 0.5rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .api-url-bar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .api-url-bar input {
            flex: 1;
            font-size: 0.8rem;
            padding: 0.4rem 0.7rem;
        }

        .api-url-bar label {
            white-space: nowrap;
        }

        footer {
            text-align: center;
            color: var(--text-dim);
            font-size: 0.8rem;
            margin-top: 2rem;
            padding-bottom: 2rem;
        }

        footer a { color: var(--accent); text-decoration: none; }
        footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>☉ Human Design Calculator</h1>
            <p>Calculate your natal chart using Swiss Ephemeris</p>
        </header>

        <div class="card">
            <div class="api-url-bar">
                <label for="apiUrl">API URL:</label>
                <input type="text" id="apiUrl" value="http://127.0.0.1:5100" placeholder="http://127.0.0.1:5100">
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="birthDate">Birth Date</label>
                    <input type="date" id="birthDate" value="1968-11-23">
                </div>
                <div class="form-group">
                    <label for="birthTime">Birth Time (local)</label>
                    <input type="time" id="birthTime" value="21:19" step="60">
                </div>
                <div class="form-group full-width">
                    <label for="birthPlace">Birth Place</label>
                    <input type="text" id="birthPlace" value="Drammen, Norway" placeholder="City, Country">
                </div>
                <div class="form-group full-width">
                    <button id="calculateBtn" onclick="calculate()">Calculate Chart</button>
                </div>
            </div>
        </div>

        <div class="error-msg" id="errorMsg"></div>

        <div class="result card" id="resultCard">
            <div class="result-header">
                <h2 id="resultType"></h2>
                <span class="type-badge" id="typeBadge"></span>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <div class="label">Profile</div>
                    <div class="value" id="resultProfile"></div>
                </div>
                <div class="stat-box">
                    <div class="label">Strategy</div>
                    <div class="value" id="resultStrategy"></div>
                </div>
                <div class="stat-box">
                    <div class="label">Authority</div>
                    <div class="value" id="resultAuthority"></div>
                </div>
                <div class="stat-box">
                    <div class="label">Definition</div>
                    <div class="value" id="resultDefinition"></div>
                </div>
                <div class="stat-box full-width">
                    <div class="label">Incarnation Cross</div>
                    <div class="value" id="resultCross"></div>
                </div>
            </div>

            <div class="section-title">Centers</div>
            <div class="centers-grid" id="centersGrid"></div>

            <div class="section-title">Active Channels</div>
            <div class="channels-list" id="channelsList"></div>

            <div class="section-title">Activations</div>
            <div class="activation-columns">
                <div>
                    <div class="section-title" style="margin-top:0">☉ Personality (Conscious)</div>
                    <table class="activations-table" id="personalityTable">
                        <thead><tr><th>Planet</th><th>Gate</th><th>Line</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div>
                    <div class="section-title" style="margin-top:0">◐ Design (Unconscious)</div>
                    <table class="activations-table" id="designTable">
                        <thead><tr><th>Planet</th><th>Gate</th><th>Line</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer>
            Powered by <a href="https://github.com/jarlehildrum/hd-chart-api">hd-chart-api</a>
            · Calculations by SharpAstrology + Swiss Ephemeris
        </footer>
    </div>

    <script>
        // Load saved API URL
        const savedUrl = localStorage.getItem('hdApiUrl');
        if (savedUrl) document.getElementById('apiUrl').value = savedUrl;

        async function calculate() {
            const btn = document.getElementById('calculateBtn');
            const errorMsg = document.getElementById('errorMsg');
            const resultCard = document.getElementById('resultCard');

            // Get values
            const apiUrl = document.getElementById('apiUrl').value.replace(/\/$/, '');
            const birthDate = document.getElementById('birthDate').value;
            const birthTime = document.getElementById('birthTime').value;
            const birthPlace = document.getElementById('birthPlace').value;

            if (!birthDate || !birthTime || !birthPlace) {
                showError('Please fill in all fields.');
                return;
            }

            // Save API URL
            localStorage.setItem('hdApiUrl', apiUrl);

            // Build datetime string
            const dateTime = `${birthDate}T${birthTime}:00`;

            // UI state
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Calculating...';
            errorMsg.classList.remove('visible');
            resultCard.classList.remove('visible');

            try {
                const resp = await fetch(`${apiUrl}/api/chart`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ birthDate: dateTime, birthPlace })
                });

                if (!resp.ok) {
                    const text = await resp.text();
                    throw new Error(`API error ${resp.status}: ${text}`);
                }

                const data = await resp.json();
                const chart = data.chart || data;
                renderChart(chart, data.utcBirthDate);
            } catch (err) {
                if (err.message && err.message.includes('Failed to fetch')) {
                    showError(`Could not reach API at ${apiUrl}. Check the API URL and make sure the server is running. (${err.message})`);
                } else {
                    showError(err.message || 'Failed to connect to API');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Calculate Chart';
            }
        }

        function renderChart(chart, utcDate) {
            document.getElementById('resultCard').classList.add('visible');

            // Type
            const typeDisplay = chart.type === 'ManifestingGenerator' ? 'Manifesting Generator' : chart.type;
            document.getElementById('resultType').textContent = typeDisplay;

            const badge = document.getElementById('typeBadge');
            badge.textContent = chart.profile;
            badge.className = `type-badge type-${chart.type}`;

            // Stats
            document.getElementById('resultProfile').textContent = chart.profile;
            document.getElementById('resultStrategy').textContent = chart.strategy;
            document.getElementById('resultAuthority').textContent = formatAuthority(chart.authority);
            document.getElementById('resultDefinition').textContent = formatDefinition(chart.splitDefinition);
            document.getElementById('resultCross').textContent = chart.incarnationCross;

            // Centers
            const centersGrid = document.getElementById('centersGrid');
            centersGrid.innerHTML = '';
            const centerOrder = ['Head', 'Ajna', 'Throat', 'G', 'Heart', 'SacralCenter', 'SolarPlexus', 'Spleen', 'Root'];
            const centerNames = {
                'SacralCenter': 'Sacral',
                'SolarPlexus': 'Solar Plexus',
                'G': 'G (Self)'
            };
            for (const c of centerOrder) {
                if (chart.centers && c in chart.centers) {
                    const defined = chart.centers[c];
                    const div = document.createElement('div');
                    div.className = `center-item ${defined ? 'defined' : 'undefined'}`;
                    div.innerHTML = `${defined ? '◆' : '◇'} ${centerNames[c] || c}`;
                    centersGrid.appendChild(div);
                }
            }

            // Channels
            const channelsList = document.getElementById('channelsList');
            channelsList.innerHTML = '';
            for (const ch of (chart.activeChannels || [])) {
                const span = document.createElement('span');
                span.className = 'channel-tag';
                span.textContent = ch;
                channelsList.appendChild(span);
            }

            // Activations
            fillActivationTable('personalityTable', chart.personalityActivation || []);
            fillActivationTable('designTable', chart.designActivation || []);
        }

        function fillActivationTable(tableId, activations) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';
            const planetSymbols = {
                'Sun': '☉', 'Earth': '⊕', 'NorthNode': '☊', 'SouthNode': '☋',
                'Moon': '☽', 'Mercury': '☿', 'Venus': '♀', 'Mars': '♂',
                'Jupiter': '♃', 'Saturn': '♄', 'Uranus': '♅', 'Neptune': '♆', 'Pluto': '♇'
            };
            for (const a of activations) {
                const tr = document.createElement('tr');
                const symbol = planetSymbols[a.planet] || '';
                tr.innerHTML = `<td>${symbol} ${a.planet}</td><td>${a.gate}</td><td>${a.line}</td>`;
                tbody.appendChild(tr);
            }
        }

        function formatAuthority(auth) {
            const map = {
                'Emotional': 'Emotional (Solar Plexus)',
                'Sacral': 'Sacral',
                'Spleen': 'Splenic',
                'Ego': 'Ego / Heart',
                'Self': 'Self-Projected',
                'None': 'Lunar (None)',
                'OuterAuthority': 'Outer Authority'
            };
            return map[auth] || auth;
        }

        function formatDefinition(def) {
            const map = {
                'SingleDefinition': 'Single',
                'SplitDefinition': 'Split',
                'TripleSplit': 'Triple Split',
                'QuadrupleSplit': 'Quadruple Split',
                'NoDefinition': 'No Definition'
            };
            return map[def] || def;
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('visible');
        }

        // Enter key triggers calculation
        document.querySelectorAll('input').forEach(el => {
            el.addEventListener('keydown', e => {
                if (e.key === 'Enter') calculate();
            });
        });
    </script>
</body>
</html>
